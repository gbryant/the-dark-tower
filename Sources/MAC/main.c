Copyright 2016 Gregory BryantLicensed under the Apache License, Version 2.0 (the "License");you may not use this file except in compliance with the License.You may obtain a copy of the License at    http://www.apache.org/licenses/LICENSE-2.0Unless required by applicable law or agreed to in writing, softwaredistributed under the License is distributed on an "AS IS" BASIS,WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.See the License for the specific language governing permissions andlimitations under the License./***********************************************************************/#define MAINSOURCEFILE 1#include "ProjectHeaders.h"#include "globals.h"#define ASSIGN_KEY_FILTER(X,Y,Z)\controlOwner=X;\SetControlProperty(Z,kCreatorCode,kControlOwner,sizeof(long),&controlOwner);\controlType=Y;\SetControlProperty(Z,kCreatorCode,kControlType,sizeof(long),&controlType);\SetControlData(Z,kControlEditTextPart,kControlEditTextValidationProcTag,sizeof(ControlEditTextValidationUPP),&gEditTextValidaterUPP);\SetControlData(Z,kControlEditTextPart,kControlEditTextKeyFilterTag,sizeof(ControlKeyFilterUPP),&gEditTextKeyFilterUPP);pascal void EditTextValidater(ControlRef control);pascal ControlKeyFilterResult EditTextKeyFilter(ControlRef theControl, SInt16 *keyCode, SInt16 *charCode, EventModifiers *modifiers);pascal OSStatus SIIN_KeyModifierHandler(EventHandlerCallRef nextHandler, EventRef theEvent, void* userData);void InitGlobals(void);void main(void){Initialize();RunApplicationEventLoop();Finalize();}void Initialize(void){MenuBarHandle		menuBar;MenuRef 			menu;OSStatus			err = noErr;long 				response;EventTypeSpec		eventType;EventHandlerUPP		handlerUPP,controlHandlerUPP,windowActivateHandlerUPP,menuHandlerUPP;Rect				winBound;ControlRef			control;ControlID			controlID;IBNibRef        	nibRef;unsigned short		index;long				stringSize;long				i,j;char				*newString,*string;long				tabCount,controlOwner,controlType;long				winType;WindowRef			tempWin;Boolean				dirty;WindowActions		action;	DragReceiveHandlerUPP	dragRecvUPP;DragTrackingHandlerUPP	dragTrackUPP;EventTypeSpec		list[10];//ProfilerInit(collectDetailed,bestTimeBase,50,50);ClearKey(&gASSMProjectKey);InitGlobals();err = CreateNibReference(CFSTR ("TheDarkTower"), &nibRef);if(err){DebugFunction("\pError Creating Nib Reference: TheDarkTower");}err = CreateNibReference(CFSTR ("SaveChanges"), &gSaveChangesNibRef);if(err){DebugFunction("\pError Creating Nib Reference: SaveChanges");}if(gOnX){err = SetMenuBarFromNib(nibRef, CFSTR("MainMenuX"));if(err){DebugFunction("\pError Setting Menu Bar: MainMenu");}EnableMenuCommand(0,'pref');DisableMenuCommand(0,'clos');}else{err = SetMenuBarFromNib(nibRef, CFSTR("MainMenu9"));if(err){DebugFunction("\pError Setting Menu Bar: MainMenu");}}gKeyDownHandlerUPP		= NewEventHandlerUPP(KeyDownHandler);gKeyModifierHandlerUPP	= NewEventHandlerUPP(KeyModifierHandler);gSIIN_KeyModifierHandlerUPP	= NewEventHandlerUPP(SIIN_KeyModifierHandler);GetIndMenuItemWithCommandID(0,'pref',1,&menu,&index);SetMenuItemCommandKey(menu,index,0,',');err = CreateWindowFromNib(nibRef, CFSTR("MainWindow"), &gAppWindow);if(err){DebugFunction("\pError Creating Window: MainWindow");}err = CreateWindowFromNib(nibRef, CFSTR("SingleInstructions"), &gSingleInstructionWindow);if(err){DebugFunction("\pError Creating Window: SingleInstructions");}winType = kSingleInstruction;SetWindowProperty(gSingleInstructionWindow,kCreatorCode,kWindowType,sizeof(long),&winType);winType = kMain;SetWindowProperty(gAppWindow,kCreatorCode,kWindowType,sizeof(long),&winType);dirty = false;SetWindowModified(gAppWindow,false);SetWindowProperty(gAppWindow,kCreatorCode,kWindowDirty,sizeof(Boolean),&dirty);action = kExisting;SetWindowProperty(gAppWindow,kCreatorCode,kWindowAction,sizeof(WindowActions),&action);err = CreateWindowFromNib(gSaveChangesNibRef, CFSTR("SaveChangesWindow"), &tempWin);if(err){DebugFunction("\pError Creating Window: SaveChangesWindow");}winType = kAskSave;SetWindowProperty(tempWin,kCreatorCode,kWindowType,sizeof(long),&winType);SetWindowProperty(gAppWindow,kCreatorCode,kSaveSheet,sizeof(WindowRef),&tempWin);list[0].eventClass=kEventClassKeyboard;list[0].eventKind=kEventRawKeyDown;list[1].eventClass=kEventClassKeyboard;list[1].eventKind=kEventRawKeyRepeat;InstallWindowEventHandler(tempWin,gKeyDownHandlerUPP,2,list,&gData,NULL);list[0].eventClass=kEventClassKeyboard;list[0].eventKind=kEventRawKeyModifiersChanged;list[1].eventClass=kEventClassKeyboard;list[1].eventKind=kEventRawKeyDown;list[2].eventClass=kEventClassKeyboard;list[2].eventKind=kEventRawKeyRepeat;InstallWindowEventHandler(gAppWindow,gKeyModifierHandlerUPP,3,list,&gData,NULL);list[0].eventClass=kEventClassKeyboard;list[0].eventKind=kEventRawKeyModifiersChanged;list[1].eventClass=kEventClassKeyboard;list[1].eventKind=kEventRawKeyDown;list[2].eventClass=kEventClassKeyboard;list[2].eventKind=kEventRawKeyRepeat;InstallWindowEventHandler(gSingleInstructionWindow,gSIIN_KeyModifierHandlerUPP,3,list,&gData,NULL);DisposeNibReference(nibRef);AssociateControls();gMainControlFocus	=	(ControlRef*)NewPtr(sizeof(ControlRef)*10);gMainCurrFocus		=	-1;gMainControlFocus[0] = gAppControls.cfrgSourceName;gMainControlFocus[1] = gAppControls.cfrgDataName;gMainControlFocus[2] = gAppControls.cfrgRelocationName;gMainControlFocus[3] = gAppControls.cfrgResourceName;gMainControlFocus[4] = gAppControls.cfrgmain;gMainControlFocus[5] = gAppControls.cfrginit;gMainControlFocus[6] = gAppControls.cfrgterm;gMainControlFocus[7] = gAppControls.cfrgProduct;gMainControlFocus[8] = gAppControls.cfrgType;gMainControlFocus[9] = gAppControls.cfrgCreator;gSIINControlFocus	=	(ControlRef*)NewPtr(sizeof(ControlRef)*4);gSIINCurrFocus		=	-1;gSIINControlFocus[0] = gAppControls.siinAss;gSIINControlFocus[1] = gAppControls.siinAssResult;gSIINControlFocus[2] = gAppControls.siinDiss;gSIINControlFocus[3] = gAppControls.siinDissResult;ASSIGN_KEY_FILTER(kASSM_Cfrg,kSourcePath,gAppControls.cfrgSourceName)ASSIGN_KEY_FILTER(kASSM_Cfrg,kDataPath,gAppControls.cfrgDataName)ASSIGN_KEY_FILTER(kASSM_Cfrg,kRelocationPath,gAppControls.cfrgRelocationName)ASSIGN_KEY_FILTER(kASSM_Cfrg,kResourcePath,gAppControls.cfrgResourceName)ASSIGN_KEY_FILTER(kASSM_Cfrg,kOffsetMain,gAppControls.cfrgmain)ASSIGN_KEY_FILTER(kASSM_Cfrg,kOffsetInit,gAppControls.cfrginit)ASSIGN_KEY_FILTER(kASSM_Cfrg,kOffsetTerm,gAppControls.cfrgterm)ASSIGN_KEY_FILTER(kASSM_Cfrg,kProduct,gAppControls.cfrgProduct)ASSIGN_KEY_FILTER(kASSM_Cfrg,kType,gAppControls.cfrgType)ASSIGN_KEY_FILTER(kASSM_Cfrg,kCreator,gAppControls.cfrgCreator)controlOwner=kSIIN;err=SetControlProperty(gAppControls.siinAss,kCreatorCode,kControlOwner,sizeof(long),&controlOwner);controlType=kAss;err=SetControlProperty(gAppControls.siinAss,kCreatorCode,kControlType,sizeof(long),&controlType);err=SetControlData(gAppControls.siinAss,kControlEditTextPart,kControlEditTextValidationProcTag,sizeof(ControlEditTextValidationUPP),&gEditTextValidaterUPP);err=SetControlData(gAppControls.siinAss,kControlEditTextPart,kControlEditTextKeyFilterTag,sizeof(ControlKeyFilterUPP),&gEditTextKeyFilterUPP);//ASSIGN_KEY_FILTER(kSIIN,kAss,gAppControls.siinAss)ASSIGN_KEY_FILTER(kSIIN,kAssResult,gAppControls.siinAssResult)ASSIGN_KEY_FILTER(kSIIN,kDiss,gAppControls.siinDiss)ASSIGN_KEY_FILTER(kSIIN,kDissResult,gAppControls.siinDissResult)if(!gOnX){string = NewPtr(sizeof("Idle"));for(i=0;i<sizeof("Idle");i++){string[i]="Idle"[i];}for(stringSize=0;string[stringSize]!=0;stringSize++){}tabCount = ((516/2)-(TextWidth(string,0,stringSize)/2))/CharWidth('\t');newString = NewPtr(stringSize+tabCount);for(i=0;i<tabCount;i++){newString[i]='\t';}for(j=0;j<stringSize;i++,j++){newString[i]=string[j];}stringSize+=tabCount;SetControlData(gAppControls.statusText, kControlEditTextPart,kControlStaticTextTextTag,stringSize,newString);DisposePtr(newString);DisposePtr(string);string = NewPtr(sizeof("Command Period To Cancel"));for(i=0;i<sizeof("Command Period To Cancel");i++){string[i]="Command Period To Cancel"[i];}for(stringSize=0;string[stringSize]!=0;stringSize++){}tabCount = ((516/2)-(TextWidth(string,0,stringSize)/2))/CharWidth('\t');newString = NewPtr(stringSize+tabCount);for(i=0;i<tabCount;i++){newString[i]='\t';}for(j=0;j<stringSize;i++,j++){newString[i]=string[j];}stringSize+=tabCount;SetControlData(gAppControls.cancelText,kControlEditTextPart,kControlStaticTextTextTag,stringSize,newString);DisposePtr(newString);DisposePtr(string);string = NewPtr(sizeof("Select Target..."));for(i=0;i<sizeof("Select Target...");i++){string[i]="Select Target..."[i];}for(stringSize=0;string[stringSize]!=0;stringSize++){}tabCount = ((476/2)-(TextWidth(string,0,stringSize)/2))/CharWidth('\t');newString = NewPtr(stringSize+tabCount);for(i=0;i<tabCount;i++){newString[i]='\t';}for(j=0;j<stringSize;i++,j++){newString[i]=string[j];}stringSize+=tabCount;SetControlData(gAppControls.p2TargetName,kControlEditTextPart,kControlStaticTextTextTag,stringSize,newString);SetControlData(gAppControls.p3TargetName,kControlEditTextPart,kControlStaticTextTextTag,stringSize,newString);DisposePtr(newString);DisposePtr(string);}DeactivateControl(gAppControls.cfrgEditSource);DeactivateControl(gAppControls.cfrgEditRelocation);DeactivateControl(gAppControls.p1GoButton);DeactivateControl(gAppControls.p2GoButton);DeactivateControl(gAppControls.p3GoButton);DeactivateControl(gAppControls.p1Save);DeactivateControl(gAppControls.p1SaveAs);DeactivateControl(gAppControls.p1New);DeactivateControl(gAppControls.cfrgDataExports);DisableMenuCommand(0,'save');DisableMenuCommand(0,'svas');ShowWindow(gAppWindow);HideControl(gAppControls.p1mach);ShowControl(gAppControls.p1cfrg);SetControlValue(gAppControls.p1Target,1);dragRecvUPP = NewDragReceiveHandlerUPP(MyDragReceiveHandlerCallback);InstallReceiveHandler(dragRecvUPP,gAppWindow,(void*)0);dragTrackUPP = NewDragTrackingHandlerUPP(MyDragTrackingHandlerCallback);InstallTrackingHandler(dragTrackUPP,gAppWindow,(void*)0);//DisposeDragReceiveHandlerUPP(dragRecvUPP);//DisposeDragTrackingHandlerUPP(dragTrackUPP);gAELaunched = false;gGlobalSettings.labels = true;gGlobalSettings.procs = true;gGlobalSettings.bfspeed = true;gAborted = false;CheckPrefs();gLabelListSize=0;gCurrPointerRecord = &gPointerRecord;gPointerRecord.prev=0;gPointerRecord.next=0;gPointerRecord.ptr=0;gPointerRecord.line=0;gDataOffsets = nil;gSaveBoxEventProc = NewNavEventUPP(SaveBoxEventProc);gAEHandler = NewAEEventHandlerUPP(AEHandler);AEInstallEventHandler(kCoreEventClass,kAEOpenDocuments,gAEHandler,kAEOpenDocuments,false);AEInstallEventHandler(kCoreEventClass,kAEQuitApplication,gAEHandler,kAEQuitApplication,false);gTempMouseDownHandlerUPP = NewEventHandlerUPP(MouseDownHandler);/*list[0].eventClass=kEventClassKeyboard;list[0].eventKind=kEventRawKeyDown;list[1].eventClass=kEventClassKeyboard;list[1].eventKind=kEventRawKeyRepeat;InstallWindowEventHandler(gAppWindow,gTempMouseDownHandlerUPP,2,list,&gData,NULL);*/handlerUPP = NewEventHandlerUPP(AppCommandHandler);eventType.eventClass = kEventClassCommand;eventType.eventKind = kEventProcessCommand;InstallApplicationEventHandler(handlerUPP,1,&eventType,&gData,NULL);/*list[0].eventClass=kEventClassMenu;list[0].eventKind=kEventMenuOpening;list[1].eventClass=kEventClassMenu;list[1].eventKind=kEventMenuTargetItem;menuHandlerUPP = NewEventHandlerUPP(AppMenuHandler);InstallApplicationEventHandler(menuHandlerUPP,2,list,&gData,NULL);*/list[0].eventClass=kEventClassControl;list[0].eventKind=kEventControlHit;controlHandlerUPP = NewEventHandlerUPP(AppControlHandler);InstallApplicationEventHandler(controlHandlerUPP,1,list,&gData,NULL);list[0].eventClass=kEventClassWindow;list[0].eventKind=kEventWindowActivated;windowActivateHandlerUPP = NewEventHandlerUPP(AppWindowHandler);InstallApplicationEventHandler(windowActivateHandlerUPP,1,list,&gData,NULL);/*list[0].eventClass=kEventClassWindow;list[0].eventKind=kEventWindowClosed;winCloseHandlerUPP = NewEventHandlerUPP(WindowCloseHandler);InstallApplicationEventHandler(winCloseHandlerUPP,1,list,&gData,NULL);*/list[0].eventClass=kEventClassWindow;list[0].eventKind=kEventWindowClose;gWinCloseHandlerUPP = NewEventHandlerUPP(WindowCloseHandler);InstallWindowEventHandler(gAppWindow,gWinCloseHandlerUPP,1,list,&gData,NULL);InstallWindowEventHandler(gSingleInstructionWindow,gWinCloseHandlerUPP,1,list,&gData,NULL);InitCursor();//SetRect(&winBound,0,0,1,1);//CreateNewWindow(kMovableModalWindowClass,kWindowNoAttributes,&winBound,&gAppWindow);//SetRect(&winBound,10,40,390,50);//CreateProgressBarControl(gAppWindow,&winBound,0,0,0,true,&gAppControls.progressBar);//InstallStandardEventHandler(GetControlEventTarget(gAppControls.progressBar));//RepositionWindow(gAppWindow,NULL,kWindowCenterOnMainScreen);//InstallStandardEventHandler(GetWindowEventTarget(gAppWindow));//SetWindowTitleWithCFString(gAppWindow,CFSTR("Progress..."));//SetRect(&winBound,110,70,400,90);//CreateStaticTextControl(gAppWindow,&winBound,CFSTR("Command Period To Cancel"),0,&gAppBottomText);//SetRect(&winBound,120,10,410,30);//CreateStaticTextControl(gAppWindow,&winBound,CFSTR(""),0,&gAppTopText);//InstallStandardEventHandler(GetControlEventTarget(gAppTopText));//InstallStandardEventHandler(GetControlEventTarget(gAppBottomText));}void Finalize(void){#ifdef __POWERPC__//ProfilerDump("\pProfiler Output");//ProfilerTerm();#endifif(gDISSFileRef){DisposePtr(gDISSFileRef);}if(gEXPLFileRef){DisposePtr(gDISSFileRef);}ExitToShell();}pascal OSStatus WindowCloseHandler(EventHandlerCallRef nextHandler, EventRef theEvent, void* userData){WindowRef		window;Boolean			dirty;unsigned long	size;long			winType;FileReference	prefsFSS;long			count;void			*err;void			*fRefNumber;WindowRef		saveWin;DataView		*srcDataView;GetEventParameter(theEvent, kEventParamDirectObject, typeWindowRef, NULL, sizeof(WindowRef), NULL, &window);if(!GetWindowProperty(window,kCreatorCode,kWindowDirty,sizeof(Boolean),0,&dirty)){	if(dirty)	{		GetWindowProperty(window,kCreatorCode,kWindowType,sizeof(long),0,&winType);		switch(winType)		{			case kSourceEditor:			{			GetWindowProperty(window,kCreatorCode,kSaveSheet,sizeof(WindowRef),0,&saveWin);			ShowSheetWindow(saveWin,window);			return noErr;			break;			}			case kRelocationEditor:			{			GetWindowProperty(window,kCreatorCode,kSaveSheet,sizeof(WindowRef),0,&saveWin);			ShowSheetWindow(saveWin,window);			return noErr;			break;			}			case kPreferences:			{			prefsFSS = FileRef_Allocate();			FSMakeFSSpec(0,0,"\p:TheDarkTower.config",(FSSpec*)prefsFSS);			err = FSpOpenDF(prefsFSS,fsRdWrPerm,&fRefNumber);			if(err){DebugFunction("\pFile System Error");}			count = sizeof(Boolean);			err = FSWrite(fRefNumber,&count,&gGlobalSettings.labels);			if(err){DebugFunction("\pFile System Error");}			count = sizeof(Boolean);			err = FSWrite(fRefNumber,&count,&gGlobalSettings.procs);			if(err){DebugFunction("\pFile System Error");}			count = sizeof(Boolean);			err = FSWrite(fRefNumber,&count,&gGlobalSettings.bfspeed);			if(err){DebugFunction("\pFile System Error");}			FSClose(fRefNumber);			DisposePtr((char*)prefsFSS);			if(gQuitting)			{QuitAppModalLoopForWindow(window);}			return eventNotHandledErr;			break;			}			case kMain:			{			GetWindowProperty(window,kCreatorCode,kSaveSheet,sizeof(WindowRef),0,&saveWin);			ShowSheetWindow(saveWin,window);			return noErr;			break;			}		}	}	else	{	GetWindowProperty(window,kCreatorCode,kWindowType,sizeof(long),0,&winType);		switch(winType)		{		case kSourceEditor:		{		gSourceEditorWindows--;		if(gSourceEditorWindows==0)		{ActivateControl(gAppControls.p3GoButton);}		break;		}		}	}}GetWindowProperty(window,kCreatorCode,kWindowType,sizeof(long),0,&winType);switch(winType){case kSourceEditor:					{					/*					GetWindowProperty(gSourceEditorWindow,kCreatorCode,'data',sizeof(DataView*),0,&srcDataView);					if(srcDataView->rowCount)					{DisposePtr(srcDataView->rowData);}					ActivateControl(gAppControls.p3GoButton);					*/					break;					}case kRelocationEditor:						{						if(gEnableEditRelocation)						{ActivateControl(gAppControls.cfrgEditRelocation);}						ActivateControl(gAppControls.cfrgNewRelocation);						break;						}case kPreferences:{EnableMenuCommand(0,'pref');break;}case kAskSave:{return noErr;break;}case kMain:{if(gQuitting){HideWindow(window);return noErr;}else{return noErr;}break;}case kSingleInstruction:{EnableMenuCommand(0,'siin');HideWindow(gSingleInstructionWindow);return noErr;break;}}if(gQuitting){QuitAppModalLoopForWindow(window);}return eventNotHandledErr;}pascal OSStatus AppWindowHandler(EventHandlerCallRef nextHandler, EventRef theEvent, void* userData){WindowRef		window;long			winType;Boolean			dirty;GetEventParameter(theEvent, kEventParamDirectObject, typeWindowRef, NULL, sizeof(WindowRef), NULL, &window);GetWindowProperty(window,kCreatorCode,kWindowType,sizeof(long),0,&winType);GetWindowProperty(window,kCreatorCode,kWindowDirty,sizeof(Boolean),0,&dirty);switch(winType){case kAskSave:		{		DisableMenuCommand(0,'clos');		break;		}case kMain:		{		DisableMenuCommand(0,'clos');		if(dirty)		{		EnableMenuCommand(0,'save');		EnableMenuCommand(0,'svas');		}		else		{		DisableMenuCommand(0,'save');		DisableMenuCommand(0,'svas');		}		break;		}case kRelocationEditor:		{		if(dirty)		{		EnableMenuCommand(0,'save');		EnableMenuCommand(0,'svas');		}		else		{		DisableMenuCommand(0,'save');		DisableMenuCommand(0,'svas');		}		EnableMenuCommand(0,'clos');		break;		}default:{EnableMenuCommand(0,'clos');break;}}return eventNotHandledErr;}pascal OSStatus AppMenuHandler(EventHandlerCallRef nextHandler, EventRef theEvent, void* userData){SysBeep(1);return eventNotHandledErr;}pascal OSStatus AppControlHandler(EventHandlerCallRef nextHandler, EventRef theEvent, void* userData){ControlRef			control;ControlID			controlID;ControlPartCode 	part;OSStatus			returnVal;GetEventParameter(theEvent, kEventParamDirectObject, typeControlRef, NULL, sizeof(ControlRef), NULL, &control);GetEventParameter(theEvent, kEventParamControlPart, typeControlPartCode, NULL, sizeof(ControlPartCode), NULL, &part);GetControlID(control,&controlID);switch(controlID.signature){	case 'main':				{				returnVal = Handle_MAIN_Controls(controlID.id,part,GetControlOwner(control),control);				break;				}	case 'pref':				{				returnVal = Handle_PREF_Controls(controlID.id,part,GetControlOwner(control),control);				break;				}	case 'assm':				{				returnVal = Handle_ASSM_Controls(controlID.id,part,GetControlOwner(control),control);				break;				}	case 'cfrg':				{				returnVal = Handle_CFRG_Controls(controlID.id,part,GetControlOwner(control),control);				break;				}	case 'diss':				{				returnVal = Handle_DISS_Controls(controlID.id,part,GetControlOwner(control),control);				break;				}	case 'expl':				{				returnVal = Handle_EXPL_Controls(controlID.id,part,GetControlOwner(control),control);				break;				}	case 'mach':				{				returnVal = Handle_MACH_Controls(controlID.id,part,GetControlOwner(control),control);				break;				}	case 'rloc':				{				returnVal = Handle_RLOC_Controls(controlID.id,part,GetControlOwner(control),control);				break;				}	case 'src ':				{				returnVal = Handle_SRC_Controls(controlID.id,part,GetControlOwner(control),control);				break;				}	case 'asks':				{				returnVal = Handle_ASKS_Controls(controlID.id,part,GetControlOwner(control),control);				break;				}	default:	return eventNotHandledErr;		}return returnVal;}pascal OSStatus AppCommandHandler(EventHandlerCallRef nextHandler, EventRef theEvent, void* userData){HICommand  		aCommand;EventTargetRef 	controlEventTarget;EventRef		sendEvent;long			data;OSErr			err;Point			mouseLoc;FSSpec			fileSpec;EventRef		event;WindowRef		frontWin;long			winType;Boolean			dirty;Boolean			isSaved=false;long			iSelector;#include 		"instructions.c"#include		"opcodes.c"GetEventParameter(theEvent, kEventParamDirectObject, typeHICommand, NULL, sizeof(HICommand), NULL, &aCommand);switch (aCommand.commandID){case 'siin':{DisableMenuCommand(0,'siin');BringToFront(gSingleInstructionWindow);ShowWindow(gSingleInstructionWindow);}break;	case 'pref':DoSettings();break;case 'quit':			{			gQuitting=true;			CreateEvent(0,kEventClassWindow,kEventWindowClose,GetCurrentEventTime(),0,&event);			frontWin = GetFrontWindowOfClass(kAllWindowClasses,true);						while(frontWin && gQuitting)			{			SetEventParameter(event,kEventParamDirectObject,typeWindowRef,sizeof(WindowRef),&frontWin);			SendEventToWindow(event,frontWin);			RunAppModalLoopForWindow(frontWin);			frontWin = GetFrontWindowOfClass(kAllWindowClasses,true);			}						if(gQuitting)			{QuitApplicationEventLoop();}			else{ShowWindow(gAppWindow);}			break;			}case 'abou':AboutApplication();break;case 'SSAB':{			SelectSourceAndBuild();			break;			}case 'DISS':{			Disassemble();			break;			}case 'SEXP':{			Explore();			break;			}case 'save':			{				frontWin = GetFrontWindowOfClass(kAllWindowClasses,true);				GetWindowProperty(frontWin,kCreatorCode,kWindowType,sizeof(long),0,&winType);				switch(winType)				{					case kMain:					{					isSaved = Save_Project();					if(isSaved)					{					dirty = false;					SetWindowModified(frontWin,false);					SetWindowProperty(frontWin,kCreatorCode,kWindowDirty,sizeof(Boolean),&dirty);					DisableMenuCommand(0,'save');					DeactivateControl(gAppControls.p1Save);					}					break;					}					case kRelocationEditor:					{					isSaved = Save_Relocations(frontWin);					if(isSaved)					{					dirty = false;					SetWindowModified(frontWin,false);					SetWindowProperty(frontWin,kCreatorCode,kWindowDirty,sizeof(Boolean),&dirty);					DisableMenuCommand(0,'save');					}					break;					}				}			}case 'mach':HideControl(gAppControls.p1cfrg);ShowControl(gAppControls.p1mach);SetControlValue(gAppControls.p1Target,2);break;case 'cfrg':HideControl(gAppControls.p1mach);ShowControl(gAppControls.p1cfrg);SetControlValue(gAppControls.p1Target,1);break;default:	{			if\			(\			((aCommand.commandID&0xFF)>=0x30&&(aCommand.commandID&0xFF)<=0x39)\			&&\			(((aCommand.commandID&0xFF00)>>8)>=0x30&&((aCommand.commandID&0xFF00)>>8)<=0x39)\			&&\			(((aCommand.commandID&0xFF0000)>>16)>=0x30&&((aCommand.commandID&0xFF0000)>>16)<=0x39)\			&&\			(((aCommand.commandID&0xFF000000)>>24)>=0x30&&((aCommand.commandID&0xFF000000)>>24)<=0x39)\			)			{			iSelector=0;			iSelector+=(aCommand.commandID&0xFF)-0x30;			iSelector+=(((aCommand.commandID&0xFF00)>>8)-0x30)*10;			iSelector+=(((aCommand.commandID&0xFF0000)>>16)-0x30)*100;			iSelector+=(((aCommand.commandID&0xFF000000)>>24)-0x30)*1000;						MyPStrAdd((unsigned char*)instList[iSelector],"\p",gSelectedSourceItem->mnem);			gSelectedSourceItem->opcode = opcodes[iSelector];						}			return eventNotHandledErr;			}		  }return noErr;}pascal OSErr MyDragReceiveHandlerCallback (WindowRef theWindow, void *handlerRefCon, DragRef theDrag){unsigned short				numItems;DragItemRef					itemRef;FlavorType					flavorType;HFSFlavor					hfsFlavor;long						size;IconRef						iconRef;short						label;OSErr						err;Rect						rect;ControlButtonContentInfo	cntlBtnCntntInfo;PicHandle					theIconPict;long		stringSize;long		i,j;char		*newString,*string;long		tabCount;GrafPtr					port;Key			keyStructure;Str255		name;CountDragItems(theDrag,&numItems);GetDragItemReferenceNumber(theDrag,1,&itemRef);GetFlavorType(theDrag,itemRef,1,&flavorType);if(flavorType==kDragFlavorTypeHFS){GetPort(&port);SetPortWindowPort(gAppWindow);size=sizeof(HFSFlavor);GetFlavorData (theDrag,itemRef,flavorType,&hfsFlavor,&size,0);err = GetIconRefFromFile(&hfsFlavor.fileSpec,&iconRef,&label);if(err){DebugFunction("\pError Obtaining IconRef");}SetRect(&rect,0,0,48,48);theIconPict = OpenPicture(&rect);PlotIconRef(&rect,0,0,0,iconRef);ReleaseIconRef(iconRef);ClosePicture();cntlBtnCntntInfo.contentType	= kControlContentPictHandle;cntlBtnCntntInfo.u.picture		= theIconPict;if(gCurrentTab==kASSM_Tab){	gASSMProjectKey.keyFileRef = FileRef_Allocate();	FileRef_To_FileRef_Copy(&hfsFlavor.fileSpec,gASSMProjectKey.keyFileRef);	ReadKeyFile(&gASSMProjectKey,gASSMProjectKey.keyFileRef);	if(gASSMProjectKey.asmb)	{ActivateControl(gAppControls.cfrgEditSource);gEnableEditSource=true;}	if(gASSMProjectKey.relocb)	{ActivateControl(gAppControls.cfrgEditRelocation);gEnableEditRelocation=true;}	Fill_CFRG(&gASSMProjectKey);	ActivateControl(gAppControls.p1SaveAs);	ActivateControl(gAppControls.p1New);	DeactivateControl(gAppControls.p1Save);	DisableMenuCommand(0,'save');	EnableMenuCommand(0,'svas');	ActivateControl(gAppControls.p1GoButton);}else if(gCurrentTab==kDISS_Tab){	FileRef_To_FileRef_Copy(&hfsFlavor.fileSpec,gDISSFileRef);	SetBevelButtonContentInfo(gAppControls.p2TargetIcon,&cntlBtnCntntInfo);	if(!gOnX)	{	i=(StringWidth(hfsFlavor.fileSpec.name)/2);	stringSize = hfsFlavor.fileSpec.name[0];	//tabCount = ((476/2)-(StringWidth(hfsFlavor.fileSpec.name)/2))/CharWidth('\t');	tabCount = ((476/2)-(StringWidth(hfsFlavor.fileSpec.name)/2))/3;	newString = NewPtr(stringSize+tabCount);	for(i=0;i<tabCount;i++){newString[i]='\t';}	for(j=1;j<=stringSize;i++,j++){newString[i]=hfsFlavor.fileSpec.name[j];}	stringSize+=tabCount;	SetControlData(gAppControls.p2TargetName,kControlEditTextPart,kControlStaticTextTextTag,stringSize,newString);	DisposePtr(newString);	}	else	{SetControlData(gAppControls.p2TargetName,kControlEditTextPart,kControlStaticTextTextTag,hfsFlavor.fileSpec.name[0],hfsFlavor.fileSpec.name+1);}	ShowControl(gAppControls.p2TargetName);	Draw1Control(gAppControls.p2TargetIcon);	ActivateControl(gAppControls.p2GoButton);}else if(gCurrentTab==kEXPL_Tab){	FileRef_To_FileRef_Copy(&hfsFlavor.fileSpec,gEXPLFileRef);	SetBevelButtonContentInfo(gAppControls.p3TargetIcon,&cntlBtnCntntInfo);	if(!gOnX)	{	i=(StringWidth(hfsFlavor.fileSpec.name)/2);	stringSize = hfsFlavor.fileSpec.name[0];	//tabCount = ((476/2)-(StringWidth(hfsFlavor.fileSpec.name)/2))/CharWidth('\t');	tabCount = ((476/2)-(StringWidth(hfsFlavor.fileSpec.name)/2))/3;	newString = NewPtr(stringSize+tabCount);	for(i=0;i<tabCount;i++){newString[i]='\t';}	for(j=1;j<=stringSize;i++,j++){newString[i]=hfsFlavor.fileSpec.name[j];}	stringSize+=tabCount;	SetControlData(gAppControls.p3TargetName,kControlEditTextPart,kControlStaticTextTextTag,stringSize,newString);	DisposePtr(newString);	}	{SetControlData(gAppControls.p3TargetName,kControlEditTextPart,kControlStaticTextTextTag,hfsFlavor.fileSpec.name[0],hfsFlavor.fileSpec.name+1);}	ShowControl(gAppControls.p3TargetName);	Draw1Control(gAppControls.p3TargetIcon);	ActivateControl(gAppControls.p3GoButton);}SetPort(port);}else{return dragNotAcceptedErr;}return noErr;}pascal OSErr MyDragTrackingHandlerCallback(DragTrackingMessage message, WindowRef theWindow, void *handlerRefCon, DragRef theDrag){RgnHandle				hiliteFrame;GrafPtr					port;Rect					rect;RGBColor				rgbColor;Point					mousePoint;long					param;RgnHandle				bigRgn,smallRgn,diffRgn;smallRgn	= NewRgn();bigRgn		= NewRgn();diffRgn		= NewRgn();if(gOnX){SetRectRgn(bigRgn,20,42,660,536); // 3lower,3lower - 3higher,3higher than belowSetRectRgn(smallRgn,23,45,657,533);SetRect(&rect,20,42,660,536); //same as bigregion rect}else{SetRectRgn(bigRgn,22,35,533,407);SetRectRgn(smallRgn,25,38,530,404);SetRect(&rect,22,35,533,407);}XorRgn(smallRgn,bigRgn,diffRgn);rgbColor.red	=	175*257;rgbColor.green	=	168*257;rgbColor.blue	=	205*257;GetPort(&port);//SetPortWindowPort(theWindow);PenSize(3,3);RGBForeColor(&rgbColor);//20,42,660,521switch(message){	case kDragTrackingEnterHandler:	{	/*	GetDragMouse(theDrag,&mousePoint,0);	GlobalToLocal(&mousePoint);	mousePoint.h=200;mousePoint.v=25;	HandleControlClick(gAppTabs,mousePoint,0,(ControlActionUPP)-1);	*/	break;	}	case kDragTrackingEnterWindow:	{	break;	}	case kDragTrackingInWindow:	{	GetDragMouse(theDrag,&mousePoint,0);	GlobalToLocal(&mousePoint);	if((mousePoint.h>20&&mousePoint.h<660)&&(mousePoint.v>42&&mousePoint.v<521))	{		FrameRect(&rect);		gNeedsRectErased=1;	}	else	{		if(gNeedsRectErased)		{			InvalWindowRgn(gAppWindow,diffRgn);			BeginUpdate(gAppWindow);			UpdateControls(gAppWindow,diffRgn);			EndUpdate(gAppWindow);			gNeedsRectErased=0;		}		if((mousePoint.h>=209&&mousePoint.h<=298)&&(mousePoint.v>=15&&mousePoint.v<=44))		{			if(gCurrentTab!=kASSM_Tab)			{				ClearKeyboardFocus(gAppWindow);				gCurrentTab=kASSM_Tab;				SetControlValue(gAppControls.tabs,gCurrentTab);				EventRef myEvent;				ControlRef control;				ControlPartCode part;				control=gAppControls.tabs;				part=gCurrentTab;				CreateEvent(NULL,kEventClassControl,kEventControlHit,0,kEventAttributeNone,&myEvent);				SetEventParameter(myEvent, kEventParamDirectObject, typeControlRef, sizeof(ControlRef), &control);				SetEventParameter(myEvent, kEventParamControlPart, typeControlPartCode, sizeof(ControlPartCode), &part);				SendEventToApplication(myEvent);			}		}		else if((mousePoint.h>=294&&mousePoint.h<=398)&&(mousePoint.v>=15&&mousePoint.v<=44))		{			if(gCurrentTab!=kDISS_Tab)			{				ClearKeyboardFocus(gAppWindow);				gCurrentTab=kDISS_Tab;				SetControlValue(gAppControls.tabs,gCurrentTab);				EventRef myEvent;				ControlRef control;				ControlPartCode part;				control=gAppControls.tabs;				part=gCurrentTab;				CreateEvent(NULL,kEventClassControl,kEventControlHit,0,kEventAttributeNone,&myEvent);				SetEventParameter(myEvent, kEventParamDirectObject, typeControlRef, sizeof(ControlRef), &control);				SetEventParameter(myEvent, kEventParamControlPart, typeControlPartCode, sizeof(ControlPartCode), &part);				SendEventToApplication(myEvent);			}		}		else if((mousePoint.h>=399&&mousePoint.h<=472)&&(mousePoint.v>=15&&mousePoint.v<=44))		{			if(gCurrentTab!=kEXPL_Tab)			{				ClearKeyboardFocus(gAppWindow);				gCurrentTab=kEXPL_Tab;				SetControlValue(gAppControls.tabs,gCurrentTab);				EventRef myEvent;				ControlRef control;				ControlPartCode part;				control=gAppControls.tabs;				part=gCurrentTab;				CreateEvent(NULL,kEventClassControl,kEventControlHit,0,kEventAttributeNone,&myEvent);				SetEventParameter(myEvent, kEventParamDirectObject, typeControlRef, sizeof(ControlRef), &control);				SetEventParameter(myEvent, kEventParamControlPart, typeControlPartCode, sizeof(ControlPartCode), &part);				SendEventToApplication(myEvent);			}		}	}	break;	}	case kDragTrackingLeaveWindow:	{	if(gNeedsRectErased)	{			InvalWindowRgn(gAppWindow,diffRgn);			BeginUpdate(gAppWindow);			UpdateControls(gAppWindow,diffRgn);			EndUpdate(gAppWindow);			gNeedsRectErased=0;		}	break;	}	case kDragTrackingLeaveHandler:	{		if(gNeedsRectErased)		{			InvalWindowRgn(gAppWindow,diffRgn);			BeginUpdate(gAppWindow);			UpdateControls(gAppWindow,diffRgn);			EndUpdate(gAppWindow);			gNeedsRectErased=0;		}	break;	}}SetPort(port);DisposeRgn(bigRgn);DisposeRgn(smallRgn);DisposeRgn(diffRgn);return noErr;}pascal OSStatus KeyModifierHandler(EventHandlerCallRef nextHandler, EventRef theEvent, void* userData){char		charCode;UInt32		modifiers;WindowRef	frontWin,parentWindow;long			winType;Boolean			dirty;WindowActions	action;CFStringRef		openPCFStr,newPCFStr,savePCFStr,saveasPCFStr,selecttargetPCFStr;unsigned short	openP[]={'O','p','e','n',' ','P','r','o','j','e','c','t','.','.','.',' ',' ',' ','#','O'};unsigned short	newP[]={'N','e','w',' ','P','r','o','j','e','c','t',' ',' ',' ','#','N'};unsigned short	saveP[]={'S','a','v','e',' ','P','r','o','j','e','c','t',' ',' ',' ','#','S'};unsigned short	saveasP[]={'S','a','v','e',' ','P','r','o','j','e','c','t',' ','A','s','.','.','.',' ',' ',' ','#','#%','S'};//unsigned short	selecttargetP[]={'S','e','l','e','c','t',' ','T','a','r','g','e','t','.','.','.',' ',' ',' ','#','O'};unsigned short	selecttargetP[]={'#','O'};GetEventParameter(theEvent, kEventParamKeyMacCharCodes, typeChar, NULL, sizeof(char), NULL, &charCode);GetEventParameter(theEvent, kEventParamKeyModifiers, typeUInt32, NULL, sizeof(UInt32), NULL, &modifiers);frontWin = GetFrontWindowOfClass(kAllWindowClasses,true);if(frontWin==gAppWindow){if (charCode=='\t' && modifiers==2048){ClearKeyboardFocus(gAppWindow);if(gCurrentTab==kASSM_Tab){gCurrentTab=kDISS_Tab;}else if(gCurrentTab==kDISS_Tab){gCurrentTab=kEXPL_Tab;}else if(gCurrentTab==kEXPL_Tab){gCurrentTab=kASSM_Tab;}SetControlValue(gAppControls.tabs,gCurrentTab);EventRef myEvent;ControlRef control;ControlPartCode part;control=gAppControls.tabs;part=gCurrentTab;CreateEvent(NULL,kEventClassControl,kEventControlHit,0,kEventAttributeNone,&myEvent);SetEventParameter(myEvent, kEventParamDirectObject, typeControlRef, sizeof(ControlRef), &control);SetEventParameter(myEvent, kEventParamControlPart, typeControlPartCode, sizeof(ControlPartCode), &part);SendEventToApplication(myEvent);return noErr;}if (charCode=='\t' && modifiers==2560){ClearKeyboardFocus(gAppWindow);if(gCurrentTab==kASSM_Tab){gCurrentTab=kEXPL_Tab;}else if(gCurrentTab==kDISS_Tab){gCurrentTab=kASSM_Tab;}else if(gCurrentTab==kEXPL_Tab){gCurrentTab=kDISS_Tab;}SetControlValue(gAppControls.tabs,gCurrentTab);EventRef myEvent;ControlRef control;ControlPartCode part;control=gAppControls.tabs;part=gCurrentTab;CreateEvent(NULL,kEventClassControl,kEventControlHit,0,kEventAttributeNone,&myEvent);SetEventParameter(myEvent, kEventParamDirectObject, typeControlRef, sizeof(ControlRef), &control);SetEventParameter(myEvent, kEventParamControlPart, typeControlPartCode, sizeof(ControlPartCode), &part);SendEventToApplication(myEvent);return noErr;}if (charCode=='\t' && modifiers==0){	if(gCurrentTab==kASSM_Tab)	{	if(gMainCurrFocus<=8){gMainCurrFocus++;}else{gMainCurrFocus=0;}	SetKeyboardFocus(gAppWindow,gMainControlFocus[gMainCurrFocus],kControlEditTextPart);	return noErr;	}}if (charCode=='\t' && modifiers==512){	if(gCurrentTab==kASSM_Tab)	{	if(gMainCurrFocus>=1){gMainCurrFocus--;}else{gMainCurrFocus=9;}	SetKeyboardFocus(gAppWindow,gMainControlFocus[gMainCurrFocus],kControlEditTextPart);	return noErr;	}}openPCFStr=CFStringCreateWithCharacters(NULL,openP,sizeof(openP)/2);newPCFStr=CFStringCreateWithCharacters(NULL,newP,sizeof(newP)/2);savePCFStr=CFStringCreateWithCharacters(NULL,saveP,sizeof(saveP)/2);saveasPCFStr=CFStringCreateWithCharacters(NULL,saveasP,sizeof(saveasP)/2);selecttargetPCFStr=CFStringCreateWithCharacters(NULL,selecttargetP,sizeof(selecttargetP)/2);if(modifiers==256){	if(gCurrentTab==kASSM_Tab)	{		SetControlTitleWithCFString(gAppControls.p1Open,openPCFStr);		SetControlTitleWithCFString(gAppControls.p1New,newPCFStr);		SetControlTitleWithCFString(gAppControls.p1Save,savePCFStr);		SetControlTitleWithCFString(gAppControls.p1SaveAs,saveasPCFStr);		switch(charCode)		{		case 'o':		Function_kASSM_Open();		SetControlTitle(gAppControls.p1Open,"\pOpen Project...");		SetControlTitle(gAppControls.p1New,"\pNew Project");		SetControlTitle(gAppControls.p1Save,"\pSave Project");		SetControlTitle(gAppControls.p1SaveAs,"\pSave Project As...");		break;		case 'n':		Function_kASSM_New();		SetControlTitle(gAppControls.p1Open,"\pOpen Project...");		SetControlTitle(gAppControls.p1New,"\pNew Project");		SetControlTitle(gAppControls.p1Save,"\pSave Project");		SetControlTitle(gAppControls.p1SaveAs,"\pSave Project As...");		break;		case 's':		Function_kASSM_Save();		SetControlTitle(gAppControls.p1Open,"\pOpen Project...");		SetControlTitle(gAppControls.p1New,"\pNew Project");		SetControlTitle(gAppControls.p1Save,"\pSave Project");		SetControlTitle(gAppControls.p1SaveAs,"\pSave Project As...");		break;		default:return eventNotHandledErr;break;		}	}	if(gCurrentTab==kDISS_Tab)	{		SetControlTitleWithCFString(gAppControls.p2TargetIcon,selecttargetPCFStr);		switch(charCode)		{		case 'o':Function_kDISS_TargetIcon();SetControlTitle(gAppControls.p2TargetIcon,"\p");break;		default:return eventNotHandledErr;break;		}	}	if(gCurrentTab==kEXPL_Tab)	{		SetControlTitleWithCFString(gAppControls.p3TargetIcon,selecttargetPCFStr);		switch(charCode)		{		case 'o':Function_kEXPL_TargetIcon();SetControlTitle(gAppControls.p3TargetIcon,"\p");break;		default:return eventNotHandledErr;break;		}	}return noErr;}if(modifiers==2304){	if(charCode=='§')	{	return noErr;	}}if(modifiers==0){	if(gCurrentTab==kASSM_Tab)	{	SetControlTitle(gAppControls.p1Open,"\pOpen Project...");	SetControlTitle(gAppControls.p1New,"\pNew Project");	SetControlTitle(gAppControls.p1Save,"\pSave Project");	SetControlTitle(gAppControls.p1SaveAs,"\pSave Project As...");	}	if(gCurrentTab==kDISS_Tab)	{	SetControlTitle(gAppControls.p2TargetIcon,"\p");	}	if(gCurrentTab==kEXPL_Tab)	{	SetControlTitle(gAppControls.p3TargetIcon,"\p");	}}CFRelease(openPCFStr);CFRelease(newPCFStr);CFRelease(savePCFStr);CFRelease(saveasPCFStr);CFRelease(selecttargetPCFStr);}return eventNotHandledErr;}pascal OSStatus KeyDownHandler(EventHandlerCallRef nextHandler, EventRef theEvent, void* userData){char		charCode;UInt32		modifiers;WindowRef	frontWin,parentWindow;long			winType;Boolean			dirty;WindowActions	action;GetEventParameter(theEvent, kEventParamKeyMacCharCodes, typeChar, NULL, sizeof(char), NULL, &charCode);GetEventParameter(theEvent, kEventParamKeyModifiers, typeUInt32, NULL, sizeof(UInt32), NULL, &modifiers);if(charCode=='d'){frontWin = GetFrontWindowOfClass(kAllWindowClasses,true);GetSheetWindowParent(frontWin,&parentWindow);GetWindowProperty(parentWindow,kCreatorCode,kWindowType,sizeof(long),0,&winType);switch(winType){	case kMain:	{	HideSheetWindow(frontWin);	if(gQuitting)	{HideWindow(parentWindow);QuitAppModalLoopForWindow(parentWindow);}	GetWindowProperty(gAppWindow,kCreatorCode,kWindowAction,sizeof(WindowActions),0,&action);	if(action==kCreating)	{	ClearKey(&gASSMProjectKey);	Fill_CFRG((Key*)0);	DeactivateControl(gAppControls.p1New);	DeactivateControl(gAppControls.p1Save);	DeactivateControl(gAppControls.p1SaveAs);	DisableMenuCommand(0,'save');	DisableMenuCommand(0,'svas');	SetWindowModified(gAppWindow,false);	dirty = false;	SetWindowProperty(gAppWindow,kCreatorCode,kWindowDirty,sizeof(Boolean),&dirty);	action = kExisting;	SetWindowProperty(gAppWindow,kCreatorCode,kWindowAction,sizeof(WindowActions),&action);	}	break;	}	case kRelocationEditor:	{	HideSheetWindow(frontWin);	DisposeWindow(parentWindow);	ActivateControl(gAppControls.cfrgNewRelocation);	if(gEnableEditRelocation)	{ActivateControl(gAppControls.cfrgEditRelocation);}	if(gQuitting)	{QuitAppModalLoopForWindow(parentWindow);}	break;	}	case kSourceEditor:	{	HideSheetWindow(frontWin);	DisposeWindow(parentWindow);	//ÏActivateControl(gAppControls.cfrgNewSource);	//Ïif(gEnableEditSource)	//Ï{ActivateControl(gAppControls.cfrgEditSource);}	if(gQuitting)	{QuitAppModalLoopForWindow(parentWindow);}	break;	}}return noErr;}return eventNotHandledErr;}pascal OSStatus MouseDownHandler(EventHandlerCallRef nextHandler, EventRef theEvent, void* userData){char	charCode;UInt32	modifiers;Rect	rect;Point	point;CGrafPtr						port;GWorldPtr						offscreenGWorld;Rect							dst,theRect;OSErr							err;if(GetEventClass(theEvent)==kEventClassMouse&&IsWindowActive(gRelocEditorWindow)){	if(gRelocCellSelected)	{	GetEventParameter(theEvent, kEventParamMouseLocation, typeQDPoint, NULL, sizeof(Point), NULL, &point);	GetControlBounds(gAppControls.rlocBrowser,&rect);	GetPort(&port);	SetPort(GetWindowPort(gRelocEditorWindow));	GlobalToLocal(&point);	SetPort(port);	if(point.h<rect.right&&point.h>rect.right-19)	{	if(point.v>rect.top+20&&point.v<rect.bottom)	{	ClearKeyboardFocus(gRelocEditorWindow);	HideControl(gSelectedRelocCell);	gSelectedRelocItem=0;	gRelocCellSelected=false;	}	}	return eventNotHandledErr;	}}GetEventParameter(theEvent, kEventParamKeyMacCharCodes, typeChar, NULL, sizeof(char), NULL, &charCode);GetEventParameter(theEvent, kEventParamKeyModifiers, typeUInt32, NULL, sizeof(UInt32), NULL, &modifiers);if(charCode=='\t'&&!modifiers){return noErr;}return eventNotHandledErr;}pascal void EditTextValidater(ControlRef control){unsigned long	size;long	data;Boolean	returnVal=true;long	controlOwner,controlType;GetControlProperty(control,kCreatorCode,kControlOwner,sizeof(long),&size,&controlOwner);GetControlProperty(control,kCreatorCode,kControlType,sizeof(long),&size,&controlType);switch(controlOwner){	case kPEF_Reloc:	{		switch(controlType)		{			case k9BIT_M1:			{			break;			}			default:break;		}	break;	}	case kASSM_Cfrg:	{	break;	}	case kSIIN:	{	//DebugFunction("\pSIIN is iin!");	break;	}}}pascal ControlKeyFilterResult EditTextKeyFilter(ControlRef theControl, SInt16 *keyCode, SInt16 *charCode, EventModifiers *modifiers){long			controlOwner;unsigned long	size;Boolean			returnVal=true,dirty;GetControlProperty(theControl,kCreatorCode,kControlOwner,sizeof(long),&size,&controlOwner);if(*modifiers==cmdKey){if(!(*charCode=='v'||*charCode=='x'||*charCode=='c')){returnVal=false;}}else{switch(controlOwner){	case kPEF_Reloc:	{	returnVal = Handle_PEFReloc_KeyFilter(theControl, keyCode, charCode, modifiers);	if(returnVal)	{	dirty = true;	SetWindowModified(gRelocEditorWindow,true);	SetWindowProperty(gRelocEditorWindow,kCreatorCode,kWindowDirty,sizeof(Boolean),&dirty);	EnableMenuCommand(0,'save');	EnableMenuCommand(0,'svas');	}	break;	}	case kASSM_Cfrg:	{	returnVal = Handle_ASSM_KeyFilter(theControl, keyCode, charCode, modifiers);	if(returnVal)	{	if(!(*charCode==kDelete||*charCode==kRightArrow||*charCode==kLeftArrow	||*charCode==kUpArrow||*charCode==kDownArrow))	{	SetWindowModified(gAppWindow,true);	dirty = true;	SetWindowProperty(gAppWindow,kCreatorCode,kWindowDirty,sizeof(Boolean),&dirty);	ActivateControl(gAppControls.p1Save);	ActivateControl(gAppControls.p1SaveAs);	ActivateControl(gAppControls.p1New);	EnableMenuCommand(0,'save');	EnableMenuCommand(0,'svas');	}	}	break;	}	case kSIIN:	{	returnVal = Handle_SIIN_KeyFilter(theControl, keyCode, charCode, modifiers);	break;	}	case kSRC_Edit:	{	returnVal = Handle_SRCEdit_KeyFilter(theControl, keyCode, charCode, modifiers);	break;	}}}return returnVal;}pascal OSStatus SIIN_KeyModifierHandler(EventHandlerCallRef nextHandler, EventRef theEvent, void* userData){char		charCode;UInt32		modifiers;WindowRef	frontWin;GetEventParameter(theEvent, kEventParamKeyMacCharCodes, typeChar, NULL, sizeof(char), NULL, &charCode);GetEventParameter(theEvent, kEventParamKeyModifiers, typeUInt32, NULL, sizeof(UInt32), NULL, &modifiers);frontWin = GetFrontWindowOfClass(kAllWindowClasses,true);if(frontWin==gSingleInstructionWindow){	if (charCode=='\t' && modifiers==0)	{		if(gSIINCurrFocus<=2){gSIINCurrFocus++;}else{gSIINCurrFocus=0;}		SetKeyboardFocus(gSingleInstructionWindow,gSIINControlFocus[gSIINCurrFocus],kControlEditTextPart);		return noErr;	}	if (charCode=='\t' && modifiers==512)	{		if(gSIINCurrFocus>=1){gSIINCurrFocus--;}else{gSIINCurrFocus=3;}		SetKeyboardFocus(gSingleInstructionWindow,gSIINControlFocus[gSIINCurrFocus],kControlEditTextPart);		return noErr;	}}return eventNotHandledErr;}void InitGlobals(void){long			i;long			err;long			response;gPopupMenuPic = GetPicture(129);gEditTextPic = (PicHandle)NewHandle(sizeof(gTheData));HLock((Handle)gEditTextPic);for(i=0;i<sizeof(gTheData);i++){((char*)*gEditTextPic)[i]=gTheData[i];}HUnlock((Handle)gEditTextPic);gEditTextValidaterUPP = NewControlEditTextValidationUPP(EditTextValidater);gEditTextKeyFilterUPP = NewControlKeyFilterUPP(EditTextKeyFilter);gQuitting=0;gSourceEditorWindows = 0;gCodeBrowserListing = false;gMustClearRelocMessage=0;gRelocCellSelected=0;gEnableEditRelocation=0;gEnableEditSource=0;gAltAsmInstErrMode=false;gASSMProjectKey.keyFileRef = 0;gASSMProjectKey.dirty = 0;/*gASSMFileRef = FileRef_Allocate();*/gDISSFileRef = FileRef_Allocate();gEXPLFileRef = FileRef_Allocate();gJustAddedReloc=true;gCurrentTab = kASSM_Tab;gRelocationEditorItemEnum=1;gRelocationEditorItems = 0;gRelocationEditorSelected = 0;gRelocationRemovingSelection = false;gSourceEditorItemEnum=1;gSourceEditorItems = 0;gSourceEditorSelected = 0;gSourceRemovingSelection = false;err = Gestalt(gestaltSystemVersion, &response);if(err){DebugFunction("\pGestalt Error: gestaltSystemVersion");}if ((response & 0xFFFF)>=0x1000){gOnX=true;}else{gOnX=false;}}	